{"version":3,"file":"YpRecommendations.js","sourceRoot":"","sources":["../../../src/@yrpri/yp-app/YpRecommendations.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,8BAA8B,CAAA;AAGzD,MAAM,OAAO,iBAAkB,SAAQ,UAAU;IAkB/C,YAAY,SAAsB;QAChC,KAAK,EAAE,CAAC;QAjBV,8BAAyB,GAAqC,EAAE,CAAA;QAIhE,4BAAuB,GAA4B,EAAE,CAAA;QAErD,sCAAiC,GAA0B,EAAE,CAAA;QAI7D,4BAAuB,GAA2B,EAAE,CAAA;QAEpD,kBAAa,GAAG,CAAC,CAAA;QAMf,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;IAC7B,CAAC;IAED,6BAA6B,CAAE,OAAe,EAAE,aAAqB,EAAE,sBAAgC;QACrG,IAAI,CAAC,aAAa,GAAC,aAAa,CAAC;QACjC,IAAI,CAAC,uBAAuB,CAAC,OAAO,CAAC,GAAG,sBAAsB,CAAC;QAC/D,IAAI,CAAC,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,EAAE;YAC5C,IAAI,CAAC,2BAA2B,CAAC,OAAO,CAAC,CAAC;SAC3C;aAAM,IAAI,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,MAAM,GAAC,CAAC,EAAE;YAC3D,MAAM,YAAY,GAAG,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC,CAAC;YACpD,IAAI,YAAY;gBACd,MAAM,CAAC,UAAU,CAAC,8BAA8B,EAAE,CAAC;YACrD,sBAAsB,CAAC,YAAY,CAAC,CAAC;SACtC;aAAM;YACL,sBAAsB,CAAC,IAAI,CAAC,CAAC;SAC9B;IACH,CAAC;IAED,qBAAqB,CAAC,IAAgB;QACpC,UAAU,CAAC,GAAG,EAAE;YACd,IAAI,SAAS,GAAC,IAAI,CAAC;YACnB,IAAI,CAAC,CAAC,IAAI,CAAC,gBAAgB,IAAI,IAAI,CAAC,gBAAgB,KAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;gBAChF,SAAS,GAAG,iCAAiC,CAAC;aAC/C;iBAAO,IAAI,CAAC,CAAC,IAAI,CAAC,gBAAgB,IAAI,IAAI,CAAC,gBAAgB,KAAG,MAAM,CAAC,IAAI,IAAI,CAAC,QAAQ,EAAE;gBACvF,SAAS,GAAG,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,CAAC;aAC9C;iBAAM,IAAI,IAAI,CAAC,gBAAgB,KAAG,OAAO,EAAE;gBAC1C,SAAS,GAAG,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC,CAAC,CAAC;aAC/D;YAED,IAAI,SAAS,EAAE;gBACb,IAAI,KAAK,EAAE,CAAC,GAAG,GAAC,SAAS,CAAC;aAC3B;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,kBAAkB,CAAC,MAAoC,EAAE,QAAgB;QACvE,IAAI,MAAM,IAAI,MAAM,CAAC,MAAM,GAAC,CAAC,EAAE;YAC7B,MAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,GAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;YAC5D,IAAI,OAAO,IAAI,OAAO,CAAC,MAAM,GAAC,CAAC;gBAC7B,OAAO,OAAO,CAAC,QAAQ,CAAC,CAAC;SAC5B;aAAM;YACL,OAAO,EAAE,CAAC;SACX;IACH,CAAC;IAED,qBAAqB,CAAC,IAAgB;QACpC,IAAI,IAAI,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,CAAC,kBAAkB,EAAE;YAC7D,OAAO,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,QAAQ,CAAC,kBAAkB,EAAE,CAAC,CAAC,CAAC;SACrE;aAAM;YACL,OAAO,EAAE,CAAC;SACX;IACH,CAAC;IAED,oBAAoB,CAAC,MAAc;QACjC,UAAU,CAAC,GAAG,EAAE;YACd,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,MAAM,CAAC,EAAE;gBACzC,IAAI,CAAC,uBAAuB,CAAC,MAAM,CAAC,GAAC,IAAI,CAAC;gBAC1C,OAAO,CAAC,GAAG,CAAC,wCAAwC,GAAC,MAAM,CAAC,CAAC;gBAC7D,KAAK,CAAC,aAAa,GAAC,MAAM,CAAC,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,EAAE;oBAC5C,IAAI,CAAC,uBAAuB,CAAC,MAAM,CAAC,GAAC,KAAK,CAAC;oBAC3C,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;gBACzB,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE;oBACf,IAAI,IAAI,EAAE;wBACR,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,CAAC;qBAClC;yBAAM;wBACL,OAAO,CAAC,KAAK,CAAC,yCAAyC,CAAC,CAAC;qBAC1D;oBACD,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,cAAc,CAAC,MAAM,CAAC,GAAC,IAAI,CAAC;gBACtD,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,EAAE,EAAE;oBACd,OAAO,CAAC,KAAK,CAAC,iDAAiD,EAAE,EAAE,CAAC,CAAC;oBACrE,IAAI,CAAC,uBAAuB,CAAC,MAAM,CAAC,GAAC,KAAK,CAAC;gBAC7C,CAAC,CAAC,CAAC;aACJ;iBAAM;gBACL,OAAO,CAAC,IAAI,CAAC,sCAAsC,GAAC,MAAM,CAAC,CAAC;aAC7D;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,yBAAyB,CAAC,OAAe;QACvC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,MAAM,GAAC,CAAC,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,CAAC,EAAE,EAAE;YACxG,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,cAAc,CAAC,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE;gBAC1F,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;aAC1E;SACD;IACH,CAAC;IAED,KAAK,CAAC,2BAA2B,CAAC,OAAe;QAC/C,MAAM,eAAe,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,0BAA0B,CAAC,OAAO,CAA2B,CAAC;QAC3G,IAAI,eAAe,EAAE;YACnB,IAAI,CAAC,iCAAiC,CAAC,OAAO,CAAC,GAAG,eAAe,CAAC,MAAM,CAAC;YACzE,IAAI,CAAC,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,EAAE;gBAC5C,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,GAAG,eAAe,CAAC;aAC3D;iBAAM;gBACL,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC;aAC3G;YACD,IAAI,IAAI,CAAC,uBAAuB,CAAC,OAAO,CAAC,EAAE;gBACzC,IAAI,CAAC,uBAAuB,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC,CAAC,CAAC;gBACtE,OAAO,IAAI,CAAC,uBAAuB,CAAC,OAAO,CAAC,CAAC;aAC9C;SACF;IACH,CAAC;IAED,gBAAgB,CAAC,OAAe;QAC9B,IAAI,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,EAAE;YAC3C,IAAI,IAAI,GAAG,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,CAAC,CAAsB,CAAC;YAC3E,IAAI,IAAI,EAAE;gBACR,IAAI,IAAI,CAAC,EAAE,KAAG,IAAI,CAAC,aAAa,EAAE;oBAChC,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,CAAC;oBAChD,IAAI,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,MAAM,GAAC,CAAC,EAAE;wBACpD,IAAI,GAAG,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;qBACnD;yBAAM;wBACL,IAAI,GAAG,IAAI,CAAC;qBACb;iBACF;gBAED,IAAI,IAAI,EAAE;oBACR,IAAI,CAAC,yBAAyB,CAAC,OAAO,CAAC,CAAC;iBACzC;gBAED,OAAO,IAAI,CAAC;aACb;iBAAM;gBACL,OAAO,CAAC,IAAI,CAAC,uDAAuD,GAAC,OAAO,CAAC,CAAC;gBAC9E,OAAO,IAAI,CAAC;aACb;SACF;aAAM;YACL,OAAO,IAAI,CAAC;SACb;IACH,CAAC;IAED,KAAK;QACH,IAAI,CAAC,0BAA0B,GAAG,EAAE,CAAC;QACrC,IAAI,CAAC,iCAAiC,GAAG,EAAE,CAAC;QAC5C,IAAI,CAAC,uBAAuB,GAAG,EAAE,CAAC;QAClC,IAAI,CAAC,yBAAyB,GAAG,EAAE,CAAC;IACtC,CAAC;CACF","sourcesContent":["import { YpCodeBase } from '../common/YpCodeBaseclass.js'\nimport { YpServerApi } from '../common/YpServerApi.js';\n\nexport class YpRecommendations extends YpCodeBase {\n\n  recommendationsGroupCache: Record<number,Array<YpPostData>> = {}\n\n  recommendationsSeenPostIds: object | undefined;\n\n  recommendationCallbacks: Record<number,Function> = {}\n\n  lastRecommendationResponseLengths: Record<number,number> = {}\n\n  currentPostId: number | undefined;\n\n  currentlyDownloadingIds: Record<number,boolean> = {}\n\n  preCacheLimit = 3\n\n  serverApi: YpServerApi;\n\n  constructor(serverApi: YpServerApi) {\n    super();\n    this.serverApi = serverApi;\n  }\n\n  getNextRecommendationForGroup (groupId: number, currentPostId: number, recommendationCallback: Function) {\n    this.currentPostId=currentPostId;\n    this.recommendationCallbacks[groupId] = recommendationCallback;\n    if (!this.recommendationsGroupCache[groupId]) {\n      this._getRecommendationsForGroup(groupId);\n    } else if (this.recommendationsGroupCache[groupId].length>0) {\n      const selectedPost = this._getSelectedPost(groupId);\n      if (selectedPost)\n        window.appGlobals.showRecommendationInfoIfNeeded();\n      recommendationCallback(selectedPost);\n    } else {\n      recommendationCallback(null);\n    }\n  }\n\n  _preCacheMediaForPost(post: YpPostData) {\n    setTimeout(() => {\n      let imagePath=null;\n      if ((!post.cover_media_type || post.cover_media_type==='none') && !post.Category) {\n        imagePath = \"https://i.imgur.com/sdsFAoT.png\";\n      } else  if ((!post.cover_media_type || post.cover_media_type==='none') && post.Category) {\n        imagePath = this._getCategoryImagePath(post);\n      } else if (post.cover_media_type==='image') {\n        imagePath = this._getImageFormatUrl(post.PostHeaderImages, 0);\n      }\n\n      if (imagePath) {\n        new Image().src=imagePath;\n      }\n    });\n  }\n\n  _getImageFormatUrl(images: Array<YpImageData>|undefined, formatId: number) {\n    if (images && images.length>0) {\n      const formats = JSON.parse(images[images.length-1].formats);\n      if (formats && formats.length>0)\n        return formats[formatId];\n    } else {\n      return \"\";\n    }\n  }\n\n  _getCategoryImagePath(post: YpPostData) {\n    if (post && post.Category && post.Category.CategoryIconImages) {\n      return this._getImageFormatUrl(post.Category.CategoryIconImages, 0);\n    } else {\n      return \"\";\n    }\n  }\n\n  _downloadItemToCache(postId: number) {\n    setTimeout(() => {\n      if (!this.currentlyDownloadingIds[postId]) {\n        this.currentlyDownloadingIds[postId]=true;\n        console.log(\"Recommendation downloading for cache: \"+postId);\n        fetch('/api/posts/'+postId).then((response) => {\n          this.currentlyDownloadingIds[postId]=false;\n          return response.json();\n        }).then((post) => {\n          if (post) {\n            this._preCacheMediaForPost(post);\n          } else {\n            console.error(\"Recommendation no post to save to cache\");\n          }\n          window.appGlobals.cache.postItemsCache[postId]=post;\n        }).catch((ex) => {\n          console.error(\"Recommendation: Error in getting post for cache\", ex);\n          this.currentlyDownloadingIds[postId]=false;\n        });\n      } else {\n        console.warn(\"Recommendation already downloading: \"+postId);\n      }\n    });\n  }\n\n  _ensureNextItemsAreCached(groupId: number) {\n    for (let i = 0; i < Math.min(this.recommendationsGroupCache[groupId].length-1, this.preCacheLimit); i++) {\n     if (!window.appGlobals.cache.postItemsCache[this.recommendationsGroupCache[groupId][i].id]) {\n       this._downloadItemToCache(this.recommendationsGroupCache[groupId][i].id);\n     }\n    }\n  }\n\n  async _getRecommendationsForGroup(groupId: number) {\n    const recommendations = await this.serverApi.getRecommendationsForGroup(groupId) as Array<YpPostData>|void;\n    if (recommendations) {\n      this.lastRecommendationResponseLengths[groupId] = recommendations.length;\n      if (!this.recommendationsGroupCache[groupId]) {\n        this.recommendationsGroupCache[groupId] = recommendations;\n      } else {\n        this.recommendationsGroupCache[groupId] = this.recommendationsGroupCache[groupId].concat(recommendations);\n      }\n      if (this.recommendationCallbacks[groupId]) {\n        this.recommendationCallbacks[groupId](this._getSelectedPost(groupId));\n        delete this.recommendationCallbacks[groupId];\n      }\n    }\n  }\n\n  _getSelectedPost(groupId: number) {\n    if (this.recommendationsGroupCache[groupId]) {\n      let post = this.recommendationsGroupCache[groupId][0] as YpPostData | null;\n      if (post) {\n        if (post.id===this.currentPostId) {\n          this.recommendationsGroupCache[groupId].shift();\n          if (this.recommendationsGroupCache[groupId].length>0) {\n            post = this.recommendationsGroupCache[groupId][0];\n          } else {\n            post = null;\n          }\n        }\n\n        if (post) {\n          this._ensureNextItemsAreCached(groupId);\n        }\n\n        return post;\n      } else {\n        console.warn(\"Recommendation no post for getSelectedPost, groupId: \"+groupId);\n        return null;\n      }\n    } else {\n      return null;\n    }\n  }\n\n  reset () {\n    this.recommendationsSeenPostIds = {};\n    this.lastRecommendationResponseLengths = {};\n    this.recommendationCallbacks = {};\n    this.recommendationsGroupCache = {};\n  }\n}\n"]}