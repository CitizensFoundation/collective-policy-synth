{"version":3,"file":"YpAnalytics.js","sourceRoot":"","sources":["../../../src/@yrpri/yp-app/YpAnalytics.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,8BAA8B,CAAA;AAEzD,MAAM,OAAO,WAAY,SAAQ,UAAU;IAA3C;;QAME,wBAAmB,GAA2B,EAAE,CAAA;IAkKlD,CAAC;IAhKC,oBAAoB,CAAC,MAAoB;QACvC,IAAI,MAAM,CAAC,eAAe,IAAI,MAAM,CAAC,eAAe,IAAI,MAAM,CAAC,eAAe,CAAC,MAAM,IAAI,MAAM,CAAC,eAAe,CAAC,MAAM,CAAC,qBAAqB,EAAE;YAC5I,EAAE,CAAC,QAAQ,EAAE,MAAM,CAAC,eAAe,CAAC,MAAM,CAAC,qBAAqB,EAAE,MAAM,CAAC,CAAC;SAC3E;aAAM,IAAI,MAAM,CAAC,qBAAqB,IAAI,MAAM,CAAC,qBAAqB,IAAE,EAAE,EAAE;YAC3E,EAAE,CAAC,QAAQ,EAAE,MAAM,CAAC,qBAAqB,EAAE,MAAM,CAAC,CAAC;SACpD;QACD,IAAI,OAAO,EAAE,IAAI,UAAU,EAAE;YAC3B,EAAE,CAAC,KAAK,EAAE,aAAa,EAAE,IAAI,CAAC,CAAC;YAC/B,EAAE,CAAC,MAAM,EAAE,UAAU,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC;YAC1C,EAAE,CAAC,KAAK,EAAE,gBAAgB,EAAE,IAAI,CAAC,CAAC;YAClC,UAAU,CAAC,GAAG,EAAE;gBACd,EAAE,CAAC,KAAK,EAAE,gBAAgB,EAAE,KAAK,CAAC,CAAC;YACrC,CAAC,EAAE,GAAG,CAAC,CAAC;SACT;aAAM;YACL,OAAO,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;SACpD;IACH,CAAC;IAED,qBAAqB,CAAC,KAAa,EAAE,gBAAoC,SAAS;QAChF,IAAI,IAAI,CAAC,cAAc,IAAI,KAAK,EAAE;YAChC,IAAI,OAAO,CAAC;YACZ,IAAI,KAAK,KAAG,UAAU,EAAE;gBACtB,OAAO,GAAC,UAAU,CAAA;aACnB;iBAAM,IAAI,KAAK,KAAG,OAAO,IAAI,aAAa,EAAE;gBAC3C,OAAO,GAAC,aAAa,CAAC;aACvB;iBAAM;gBACL,OAAO,GAAC,KAAK,CAAC;aACf;YACD,MAAM,KAAK,GAAG,IAAI,KAAK,CAAC,CAAC,EAAC,CAAC,CAAC,CAAC;YAC7B,KAAK,CAAC,GAAG,GAAG,iCAAiC,GAAC,IAAI,CAAC,cAAc,GAAC,MAAM,GAAC,OAAO,GAAC,aAAa,CAAC;YAC/F,OAAO,CAAC,KAAK,CAAC,+BAA+B,GAAC,OAAO,CAAC,CAAA;SACvD;IACH,CAAC;IAED,wBAAwB,CAAC,SAA6B;QACpD,IAAI,SAAS,IAAI,SAAS,KAAG,EAAE,EAAE;YAC/B,IAAI,YAAY,CAAC,OAAO,CAAC,sCAAsC,CAAC,IAAE,IAAI,EAAE;gBACtE,MAAM,YAAY,GAAG,IAAI,CAAC,cAAc,CAAC;gBACzC,IAAI,CAAC,cAAc,GAAG,SAAS,CAAC;gBAChC,IAAI,SAAS,KAAG,YAAY,EAAE;oBAC5B,IAAI,CAAC,qBAAqB,CAAC,UAAU,CAAC,CAAC;iBACxC;aACF;iBAAM,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,8BAA8B,CAAC,EAAE;gBAChE,gCAAgC;gBAChC,IAAI,CAAC,UAAU,CAAC,8BAA8B,EAAE,SAAS,CAAC,CAAC;aAC5D;iBAAM;gBACL,OAAO,CAAC,GAAG,CAAC,4BAA4B,CAAC,CAAC;aAC3C;SACF;aAAM;YACL,IAAI,CAAC,cAAc,GAAG,SAAS,CAAC;SACjC;IACH,CAAC;IAED,4BAA4B,CAAC,SAA6B;QACxD,SAAS,GAAG,SAAS,EAAE,IAAI,EAAE,CAAC;QAC9B,IAAI,SAAS,IAAI,SAAS,CAAC,MAAM,GAAC,CAAC,EAAE;YACnC,MAAM,YAAY,GAAG,IAAI,CAAC,kBAAkB,CAAC;YAC7C,IAAI,CAAC,kBAAkB,GAAC,SAAS,CAAC;YAClC,IAAI,SAAS,KAAG,YAAY,EAAE;gBAC5B,IAAI,CAAC,uBAAuB,CAAC,mBAAmB,EAAE,UAAU,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC;aAClF;SACF;aAAM;YACL,IAAI,CAAC,kBAAkB,GAAG,SAAS,CAAC;SACrC;IACH,CAAC;IAED,uBAAuB,CAAC,CAAgB,EAAE,CAAgB,EAClC,CAAgB,EAAE,IAA6B,SAAS,EACxD,IAA6B,SAAS,EAAE,IAA6B,SAAS;QACpG,kDAAkD;QAClD,IAAI,OAAO,EAAE,IAAI,UAAU,EAAE;YAC3B,IAAI,CAAC,IAAE,mBAAmB,EAAE;gBAC1B,EAAE,CAAC,MAAM,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;gBAC1B,OAAO,CAAC,KAAK,CAAC,yBAAyB,GAAC,CAAC,GAAC,GAAG,GAAC,CAAC,GAAC,GAAG,GAAC,CAAC,CAAC,CAAC;aACxD;YACD,IAAI,IAAI,CAAC,kBAAkB,EAAE;gBAC3B,IAAI,QAAQ,GAAG,SAAS,GAAC,IAAI,CAAC,kBAAkB,CAAC,OAAO,CAAC,IAAI,EAAC,EAAE,CAAC,CAAC;gBAClE,IAAI,CAAC,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,kBAAkB,CAAC,EAAE;oBACtD,EAAE,CAAC,QAAQ,EAAE,IAAI,CAAC,kBAAkB,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAC;oBACxD,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,kBAAkB,CAAC,GAAG,IAAI,CAAC;oBACzD,OAAO,CAAC,KAAK,CAAC,mBAAmB,GAAC,QAAQ,CAAC,CAAC;iBAC7C;gBACD,QAAQ,IAAI,OAAO,CAAC;gBACpB,OAAO,CAAC,KAAK,CAAC,aAAa,GAAC,QAAQ,GAAC,IAAI,GAAC,CAAC,GAAC,GAAG,GAAC,CAAC,GAAC,GAAG,GAAC,CAAC,CAAC,CAAC;gBACzD,EAAE,CAAC,QAAQ,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;aAC7B;SACF;aAAM;YACL,OAAO,CAAC,IAAI,CAAC,0CAA0C,GAAC,CAAC,GAAC,KAAK,GAAC,CAAC,GAAC,KAAK,GAAC,CAAC,GAAC,KAAK,GAAC,CAAC,GAAC,KAAK,GAAC,CAAC,GAAC,KAAK,GAAC,CAAC,CAAC,CAAC;SACpG;QAED,IAAI,CAAC,IAAE,mBAAmB,EAAE;YAC1B,IAAI,CAAC,qBAAqB,CAAC,CAAW,EAAE,CAAW,CAAC,CAAC;SACtD;QAED,IAAI,CAAC,KAAG,UAAU,IAAI,CAAC,KAAG,iBAAiB,EAAE;YAC3C,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;SAC3C;IACH,CAAC;IAED,kBAAkB,CAAC,MAAc,EAAE,SAAiB,EAAE,YAAoB,EAAE,kBAAkC,SAAS;QACrH,IAAI,OAAO,EAAE,IAAI,UAAU,EAAE;YAC3B,IAAI,MAAM,EAAE;gBACV,EAAE,CAAC,KAAK,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;aAC3B;YAED,IAAI,aAAa,CAAC;YAClB,IAAI,gBAAgB,GAAG,YAAY,CAAC;YAEpC,QAAO,SAAS,EAAE;gBAChB,KAAK,gBAAgB;oBACnB,aAAa,GAAG;wBACd,YAAY,EAAE,MAAM;wBACpB,YAAY,EAAE,KAAK;wBACnB,YAAY,EAAE,YAAY;wBAC1B,SAAS,EAAE,GAAG;qBACf,CAAC;oBACF,MAAM;gBACR,KAAK,aAAa;oBAChB,aAAa,GAAG;wBACd,YAAY,EAAE,YAAY;wBAC1B,SAAS,EAAE,GAAG;qBACf,CAAC;oBACF,gBAAgB,IAAI,IAAI,GAAC,eAAe,CAAC;oBACzC,MAAM;gBACR,KAAK,eAAe;oBAClB,aAAa,GAAG;wBACd,YAAY,EAAE,YAAY;wBAC1B,SAAS,EAAE,GAAG;qBACf,CAAC;oBACF,MAAM;gBACR,KAAK,eAAe;oBAClB,aAAa,GAAG;wBACd,YAAY,EAAE,MAAM;wBACpB,YAAY,EAAE,KAAK;wBACnB,YAAY,EAAE,YAAY;wBAC1B,SAAS,EAAE,GAAG;qBACf,CAAC;oBACF,MAAM;gBACR,KAAK,YAAY;oBACf,aAAa,GAAG;wBACd,YAAY,EAAE,YAAY;wBAC1B,SAAS,EAAE,GAAG;qBACf,CAAC;oBACF,gBAAgB,IAAI,IAAI,GAAC,eAAe,CAAC;oBACzC,MAAM;gBACR,KAAK,cAAc;oBACjB,aAAa,GAAG;wBACd,YAAY,EAAE,YAAY;wBAC1B,SAAS,EAAE,GAAG;qBACf,CAAC;oBACF,MAAM;gBACR,KAAK,qBAAqB;oBACxB,aAAa,GAAG;wBACd,SAAS,EAAE,GAAG;qBACf,CAAC;oBACF,MAAM;aACT;YACD,IAAI,CAAC,uBAAuB,CAAC,MAAM,EAAC,OAAO,EAAC,kBAAkB,EAAE,SAAS,EAAE,gBAAgB,EAAE,aAAa,CAAC,CAAC;SAC7G;IACH,CAAC;CACF","sourcesContent":["import { YpCodeBase } from '../common/YpCodeBaseclass.js'\n\nexport class YpAnalytics extends YpCodeBase {\n\n  pixelTrackerId: string | undefined;\n\n  communityTrackerId: string | undefined;\n\n  communityTrackerIds: Record<string,boolean> = {}\n\n  setupGoogleAnalytics(domain: YpDomainData) {\n    if (domain.public_api_keys && domain.public_api_keys && domain.public_api_keys.google && domain.public_api_keys.google.analytics_tracking_id) {\n      ga('create', domain.public_api_keys.google.analytics_tracking_id, 'auto');\n    } else if (domain.google_analytics_code && domain.google_analytics_code!=\"\") {\n      ga('create', domain.google_analytics_code, 'auto');\n    }\n    if (typeof ga == 'function') {\n      ga('set', 'anonymizeIp', true);\n      ga('send', 'pageview', location.pathname);\n      ga('set', 'nonInteraction', true);\n      setTimeout(() => {\n        ga('set', 'nonInteraction', false);\n      }, 900);\n    } else {\n      console.warn(\"Can't find Google Analytics object\");\n    }\n  }\n\n  facebookPixelTracking(event: string, detailedEvent: string | undefined = undefined) {\n    if (this.pixelTrackerId && event) {\n      let fbEvent;\n      if (event===\"pageview\") {\n        fbEvent=\"PageView\"\n      } else if (event===\"event\" && detailedEvent) {\n        fbEvent=detailedEvent;\n      } else {\n        fbEvent=event;\n      }\n      const image = new Image(1,1);\n      image.src = \"https://www.facebook.com/tr?id=\"+this.pixelTrackerId+\"&ev=\"+fbEvent+\"&noscript=1\";\n      console.debug(\"Have sent to Facebook pixel: \"+fbEvent)\n    }\n  }\n\n  setCommunityPixelTracker(trackerId: string | undefined) {\n    if (trackerId && trackerId!=='') {\n      if (localStorage.getItem(\"consentGivenForFacebookPixelTracking\")!=null) {\n        const oldTrackerId = this.pixelTrackerId;\n        this.pixelTrackerId = trackerId;\n        if (trackerId!==oldTrackerId) {\n          this.facebookPixelTracking('pageview');\n        }\n      } else if (!localStorage.getItem(\"disableFacebookPixelTracking\")) {\n        //TODO: Make sure is implemented\n        this.fireGlobal('yp-open-pixel-cookie-confirm', trackerId);\n      } else {\n        console.log(\"Facebook tracking disabled\");\n      }\n    } else {\n      this.pixelTrackerId = undefined;\n    }\n  }\n\n  setCommunityAnalyticsTracker(trackerId: string | undefined) {\n    trackerId = trackerId?.trim();\n    if (trackerId && trackerId.length>5) {\n      const oldTrackerId = this.communityTrackerId;\n      this.communityTrackerId=trackerId;\n      if (trackerId!==oldTrackerId) {\n        this.sendToAnalyticsTrackers('sendOnlyCommunity', 'pageview', location.pathname);\n      }\n    } else {\n      this.communityTrackerId = undefined;\n    }\n  }\n\n  sendToAnalyticsTrackers(a: string|object, b: string|object,\n                          c: string|object, d: string|object|undefined = undefined,\n                          e: string|object|undefined = undefined, f: string|object|undefined = undefined) {\n    //console.debug(\"Analytics \"+a+\" \"+b+\" \"+c+\" \"+d);\n    if (typeof ga == 'function') {\n      if (a!='sendOnlyCommunity') {\n        ga('send', b, c, d, e, f);\n        console.debug(\"Analytics global: send \"+b+\" \"+c+\" \"+d);\n      }\n      if (this.communityTrackerId) {\n        let sendName = 'tracker'+this.communityTrackerId.replace(/-/g,'');\n        if (!this.communityTrackerIds[this.communityTrackerId]) {\n          ga('create', this.communityTrackerId, 'auto', sendName);\n          this.communityTrackerIds[this.communityTrackerId] = true;\n          console.debug(\"Created tracker: \"+sendName);\n        }\n        sendName += '.send';\n        console.debug(\"Analytics: \"+sendName+\": \"+b+\" \"+c+\" \"+d);\n        ga(sendName, b, c, d, e, f);\n      }\n    } else {\n      console.warn(\"Google analytics message not sent for a:\"+a+\" b:\"+b+\" c:\"+c+\" d:\"+d+\" e:\"+e+\" f:\"+f);\n    }\n\n    if (a!='sendOnlyCommunity') {\n      this.facebookPixelTracking(b as string, c as string);\n    }\n\n    if (b===\"pageview\" && a!==\"sendOnlyProject\") {\n      window.appGlobals.activity('pageview', c);\n    }\n  }\n\n  sendLoginAndSignup(userId: number, eventType: string, authProvider: string, validationError: string|undefined=undefined) {\n    if (typeof ga == 'function') {\n      if (userId) {\n        ga('set', '&uid', userId);\n      }\n\n      let fieldsObjects;\n      let authProviderText = authProvider;\n\n      switch(eventType) {\n        case 'Signup Success':\n          fieldsObjects = {\n            'dimension1': userId,\n            'dimension2': 'Yes',\n            'dimension3': authProvider,\n            'metric1': '1'\n          };\n          break;\n        case 'Signup Fail':\n          fieldsObjects = {\n            'dimension3': authProvider,\n            'metric2': '1'\n          };\n          authProviderText += \": \"+validationError;\n          break;\n        case 'Signup Submit':\n          fieldsObjects = {\n            'dimension3': authProvider,\n            'metric3': '1'\n          };\n          break;\n        case 'Login Success':\n          fieldsObjects = {\n            'dimension1': userId,\n            'dimension2': 'Yes',\n            'dimension3': authProvider,\n            'metric4': '1'\n          };\n          break;\n        case 'Login Fail':\n          fieldsObjects = {\n            'dimension3': authProvider,\n            'metric5': '1'\n          };\n          authProviderText += \": \"+validationError;\n          break;\n        case 'Login Submit':\n          fieldsObjects = {\n            'dimension3': authProvider,\n            'metric6': '1'\n          };\n          break;\n        case 'Signup/Login Opened':\n          fieldsObjects = {\n            'metric7': '1'\n          };\n          break;\n      }\n      this.sendToAnalyticsTrackers('send','event','Login and Signup', eventType, authProviderText, fieldsObjects);\n    }\n  }\n}\n"]}