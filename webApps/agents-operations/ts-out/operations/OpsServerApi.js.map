{"version":3,"file":"OpsServerApi.js","sourceRoot":"","sources":["../../src/operations/OpsServerApi.ts"],"names":[],"mappings":"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","sourcesContent":["import { YpServerApi } from \"@yrpri/webapp/common/YpServerApi\";\nimport { PsOperationsBaseNode } from \"./ps-operations-base-node\";\nimport { BaseChatBotServerApi } from \"../chatBot/BaseChatBotApi\";\n\nexport class OpsServerApi extends BaseChatBotServerApi {\n  baseAgentsPath = '/agents/';\n  constructor(urlPath: string = '/api') {\n    super();\n    this.baseUrlPath = urlPath;\n  }\n\n  public async getAgent(agentId: number): Promise<PsAgentAttributes> {\n    return (await this.fetchWrapper(this.baseUrlPath + `${this.baseAgentsPath}${agentId}`,{}, false)) as unknown as PsAgentAttributes;\n  }\n\n  public async getCrt(groupId: number): Promise<LtpCurrentRealityTreeData> {\n    return (await this.fetchWrapper(this.baseUrlPath + `${this.baseAgentsPath}${groupId}`,{}, false)) as unknown as LtpCurrentRealityTreeData;\n  }\n\n  public createTree(\n    crt: LtpCurrentRealityTreeData\n  ): Promise<LtpCurrentRealityTreeData> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `/crt`,\n      {\n        method: 'POST',\n        body: JSON.stringify(crt),\n      },\n      false\n    ) as Promise<LtpCurrentRealityTreeData>;\n  }\n\n  public updateNodeChildren(\n    treeId: string | number,\n    nodeId: string,\n    childrenIds: string[]\n  ): Promise<void> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${treeId}/updateChildren`,\n      {\n        method: 'PUT',\n        body: JSON.stringify({\n          nodeId,\n          childrenIds\n        }),\n      },\n      false\n    ) as Promise<void>;\n  }\n\n\n  public reviewConfiguration(\n    wsClientId: string,\n    crt: LtpCurrentRealityTreeData\n  ): Promise<string> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}/reviewConfiguration`,\n      {\n        method: 'PUT',\n        body: JSON.stringify({\n          context: crt.context,\n          undesirableEffects: crt.undesirableEffects,\n          wsClientId,\n        }),\n      },\n      false,\n      undefined\n    ) as Promise<string>;\n  }\n\n  public createDirectCauses(\n    treeId: string | number,\n    parentNodeId: string\n  ): Promise<LtpCurrentRealityTreeDataNode[]> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${treeId}/createDirectCauses`,\n      {\n        method: 'POST',\n        body: JSON.stringify({\n          parentNodeId,\n        }),\n      },\n      false\n    ) as Promise<LtpCurrentRealityTreeDataNode[]>;\n  }\n\n  public addDirectCauses(\n    treeId: string | number,\n    parentNodeId: string,\n    causes: string[],\n    type: CrtNodeType\n  ): Promise<LtpCurrentRealityTreeDataNode[]> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${treeId}/addDirectCauses`,\n      {\n        method: 'POST',\n        body: JSON.stringify({\n          parentNodeId,\n          causes,\n          type\n        }),\n      },\n      false\n    ) as Promise<LtpCurrentRealityTreeDataNode[]>;\n  }\n\n  public async getAgentCosts(agentId: number): Promise<number> {\n    const response = await this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${agentId}/costs`,\n      {\n        method: 'GET',\n      },\n      false\n    ) as { totalCost: string };\n    return parseFloat(response.totalCost);\n  }\n\n  public sendGetRefinedCauseQuery(\n    crtTreeId: string | number,\n    crtNodeId: string,\n    chatLog: PsAiChatWsMessage[],\n    wsClientId: string,\n    effect?: string,\n    causes?: string[],\n    validationErrors?: string[]\n  ): Promise<LtpChatBotCrtMessage> {\n    // Filter out all chatMessages with type==thinking\n    chatLog = chatLog.filter(chatMessage => chatMessage.type != 'thinking' && chatMessage.type != 'noStreaming');\n\n    const simplifiedChatLog = chatLog.map(chatMessage => {\n      return {\n        sender: chatMessage.sender == 'bot' ? 'assistant' : 'user',\n        message: chatMessage.rawMessage\n          ? chatMessage.rawMessage\n          : chatMessage.message,\n      };\n    });\n\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${crtTreeId}/getRefinedCauses`,\n      {\n        method: 'POST',\n        body: JSON.stringify({ wsClientId, crtNodeId, chatLog: simplifiedChatLog, effect, causes, validationErrors }),\n      },\n      false\n    ) as Promise<LtpChatBotCrtMessage>;\n  }\n\n  public runValidationChain(\n    crtTreeId: string | number,\n    crtNodeId: string,\n    chatLog: PsAiChatWsMessage[],\n    wsClientId: string,\n    effect: string,\n    causes: string[]\n  ): Promise<LtpChatBotCrtMessage> {\n    // Filter out all chatMessages with type==thinking\n    chatLog = chatLog.filter(chatMessage => chatMessage.type != 'thinking' && chatMessage.type != 'noStreaming');\n\n    const simplifiedChatLog = chatLog.map(chatMessage => {\n      return {\n        sender: chatMessage.sender == 'bot' ? 'assistant' : 'user',\n        message: chatMessage.rawMessage\n          ? chatMessage.rawMessage\n          : chatMessage.message,\n      };\n    });\n\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${crtTreeId}/runValidationChain`,\n      {\n        method: 'POST',\n        body: JSON.stringify({\n          wsClientId,\n          crtNodeId,\n          chatLog: simplifiedChatLog,\n          effect,\n          causes,\n        }),\n      },\n      false\n    ) as Promise<LtpChatBotCrtMessage>;\n  }\n\n\n  public updateNode(\n    agentId: number,\n    updatedNode: PsAgentAttributes\n  ): Promise<void> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${agentId}`,\n      {\n        method: 'PUT',\n        body: JSON.stringify(updatedNode),\n      },\n      false\n    ) as Promise<void>;\n  }\n\n  public updateNodeConfiguration(\n    agentId: number,\n    nodeId: number,\n    nodeType: 'agent' | 'connector',\n    updatedConfig: any\n  ): Promise<void> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${agentId}/${nodeType}/${nodeId}/configuration`,\n      {\n        method: 'PUT',\n        body: JSON.stringify(updatedConfig),\n      },\n      false\n    ) as Promise<void>;\n  }\n\n  public async getAgentStatus(agentId: number): Promise<PsAgentStatus> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${agentId}/status`,\n      {\n        method: 'GET',\n      },\n      false\n    ) as Promise<PsAgentStatus>;\n  }\n\n  async controlAgent(agentId: number, action: 'start' | 'pause' | 'stop') {\n    return this.fetchWrapper(\n      `/api/agents/${agentId}/control`,\n      {\n        method: 'POST',\n        body: JSON.stringify({ action: action }),\n      }\n    );\n  }\n\n  async startAgent(agentId: number) {\n    return this.controlAgent(agentId, 'start');\n  }\n\n  async pauseAgent(agentId: number) {\n    return this.controlAgent(agentId, 'pause');\n  }\n\n  async stopAgent(agentId: number) {\n    return this.controlAgent(agentId, 'stop');\n  }\n\n  public deleteNode(\n    treeId: string | number,\n    nodeId: string\n  ): Promise<void> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `${this.baseAgentsPath}${treeId}`,\n      {\n        method: 'DELETE',\n        body: JSON.stringify({ nodeId }),\n      },\n      false\n    ) as Promise<void>;\n  }\n}\n"]}