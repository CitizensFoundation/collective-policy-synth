{"version":3,"file":"ps-agent-node.js","sourceRoot":"","sources":["../../src/operations/ps-agent-node.ts"],"names":[],"mappings":"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","sourcesContent":["import { css, html, nothing } from 'lit';\nimport { property, customElement, state } from 'lit/decorators.js';\n\nimport '@material/web/iconbutton/icon-button.js';\nimport '@material/web/progress/circular-progress.js';\nimport '@material/web/progress/linear-progress.js';\nimport '@material/web/menu/menu.js';\nimport '@material/web/menu/menu-item.js';\n\nimport { OpsServerApi } from './OpsServerApi.js';\nimport { PsOperationsBaseNode } from './ps-operations-base-node.js';\nimport { MdMenu } from '@material/web/menu/menu.js';\n\n@customElement('ps-agent-node')\nexport class PsAgentNode extends PsOperationsBaseNode {\n  @property({ type: Object })\n  agent!: PsAgentAttributes;\n\n  @property({ type: Number })\n  agentId!: number;\n\n  @property({ type: Boolean })\n  isWorking = false;\n\n  @state()\n  private latestMessage: string = '';\n\n  @state()\n  private progress: number | undefined;\n\n  api: OpsServerApi;\n  private statusInterval: number | undefined;\n\n  constructor() {\n    super();\n    this.api = new OpsServerApi();\n  }\n\n  connectedCallback(): void {\n    super.connectedCallback();\n    this.agent = window.psAppGlobals.getAgentInstance(this.agentId);\n    this.startStatusUpdates();\n  }\n\n  disconnectedCallback(): void {\n    super.disconnectedCallback();\n    this.stopStatusUpdates();\n  }\n\n  startStatusUpdates() {\n    this.updateAgentStatus();\n    this.statusInterval = window.setInterval(\n      () => this.updateAgentStatus(),\n      5000\n    );\n  }\n\n  stopStatusUpdates() {\n    if (this.statusInterval) {\n      clearInterval(this.statusInterval);\n    }\n  }\n\n  async updateAgentStatus() {\n    try {\n      const status = await this.api.getAgentStatus(this.agent.id);\n      if (status) {\n        this.isWorking = status.state === 'running';\n        this.progress = status.progress;\n        this.latestMessage = status.messages[status.messages.length - 1] || '';\n        if (this.latestMessage.indexOf(\"Agent completed\") > -1) {\n          this.isWorking = false;\n          this.stopAgent();\n          this.requestUpdate();\n        }\n        this.requestUpdate();\n        this.fire('get-costs');\n      }\n    } catch (error) {\n      console.error('Failed to get agent status:', error);\n    }\n  }\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        :host {\n          display: block;\n        }\n\n        md-linear-progress {\n          margin: 16px;\n          margin-bottom: 8px;\n          margin-top: 8px;\n        }\n\n        .mainContainer {\n          height: 300px;\n          border-radius: 16px;\n          display: flex;\n          flex-direction: column;\n          overflow: hidden;\n          position: relative;\n        }\n\n        .image {\n          width: 100%;\n          height: 113px;\n          object-fit: cover;\n          border-radius: 16px 16px 0 0;\n        }\n\n        .contentContainer {\n          flex-grow: 1;\n          display: flex;\n          flex-direction: column;\n          padding: 8px;\n        }\n\n        .agentClassName {\n          font-size: 9px;\n          text-align: center;\n          margin: 8px;\n        }\n\n        .agentName {\n          font-size: 14px;\n          text-align: center;\n        }\n\n        .statusMessage {\n          font-size: 11px;\n          text-align: center;\n          margin-top: 8px;\n          border-radius: 16px;\n          flex-grow: 1;\n          color: var(--md-sys-color-on-surface-variant);\n        }\n\n        .buttonContainer {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 8px;\n          position: absolute;\n          bottom: 0;\n          left: 0;\n          right: 0;\n        }\n\n        md-circular-progress {\n          --md-circular-progress-size: 28px;\n        }\n\n        md-menu {\n          --md-menu-z-index: 1000;\n          z-index: 1000;\n        }\n\n        [hidden] {\n          display: none !important;\n        }\n      `,\n    ];\n  }\n\n  async startAgent() {\n    try {\n      await this.api.startAgent(this.agent.id);\n      this.isWorking = true;\n      window.psAppGlobals.setCurrentRunningAgentId(this.agent.id);\n      this.startStatusUpdates();\n      this.requestUpdate();\n    } catch (error) {\n      console.error('Failed to start agent:', error);\n    }\n  }\n\n  async pauseAgent() {\n    try {\n      await this.api.pauseAgent(this.agent.id);\n      this.isWorking = false;\n      window.psAppGlobals.setCurrentRunningAgentId(undefined);\n      this.stopStatusUpdates();\n      this.requestUpdate();\n    } catch (error) {\n      console.error('Failed to pause agent:', error);\n    }\n  }\n\n  async stopAgent() {\n    try {\n      await this.api.stopAgent(this.agent.id);\n      this.isWorking = false;\n      window.psAppGlobals.setCurrentRunningAgentId(undefined);\n      this.stopStatusUpdates();\n      this.requestUpdate();\n    } catch (error) {\n      console.error('Failed to stop agent:', error);\n    }\n  }\n\n  editNode() {\n    this.fire('edit-node', {\n      nodeId: this.nodeId,\n      element: this.agent,\n    });\n  }\n\n  toggleMenu() {\n    const menu = this.shadowRoot?.getElementById('menu') as MdMenu;\n    menu.open = !menu.open;\n  }\n\n  clickPlayPause() {\n    if (this.agent.id == this.currentRunningAgentId) {\n      this.fireGlobal('pause-agent', {\n        agentId: this.agent.id,\n      });\n      this.pauseAgent();\n      window.psAppGlobals.setCurrentRunningAgentId(undefined);\n    } else {\n      this.startAgent();\n      this.fireGlobal('run-agent', {\n        agentId: this.agent.id,\n      });\n      window.psAppGlobals.setCurrentRunningAgentId(this.agent.id);\n    }\n    this.requestUpdate();\n  }\n\n  renderProgress() {\n     if (this.progress === undefined) {\n      return html`<md-linear-progress indeterminate></md-linear-progress>`;\n     } else {\n      const progress = Math.min(1, Math.max(0, this.progress/100));\n      return html`<md-linear-progress\n          value=\"${progress}\"\n        ></md-linear-progress>`;\n     }\n    }\n\n  override render() {\n    if (!this.agent) return nothing;\n\n    if (this.agent.id == this.currentRunningAgentId) {\n      this.parentElement!.className = 'agentContainer agentContainerRunning';\n    } else {\n      this.parentElement!.className = 'agentContainer';\n    }\n\n    return html`\n      <div class=\"mainContainer\">\n        <img\n          class=\"image\"\n          src=\"${this.agent.Class.configuration.imageUrl}\"\n          alt=\"${this.agent.Class.name}\"\n        />\n        <div class=\"contentContainer\">\n          <div class=\"agentName\">${this.agent.configuration['name']}</div>\n          <div class=\"agentClassName\">${this.agent.Class.name}</div>\n          ${this.isWorking ? this.renderProgress() : nothing}\n          <div class=\"statusMessage\">${this.latestMessage}</div>\n        </div>\n        <div class=\"buttonContainer\">\n          <md-icon-button @click=\"${this.toggleMenu}\">\n            <md-icon>more_vert</md-icon>\n          </md-icon-button>\n          <md-icon-button\n            ?disabled=\"${window.psAppGlobals.currentRunningAgentId &&\n            this.agent.id != window.psAppGlobals.currentRunningAgentId}\"\n            @click=\"${this.clickPlayPause}\"\n          >\n            <md-icon>\n              ${this.agent.id == window.psAppGlobals.currentRunningAgentId\n                ? 'pause'\n                : 'play_arrow'}\n            </md-icon>\n          </md-icon-button>\n          <md-icon-button @click=\"${this.editNode}\">\n            <md-icon>settings</md-icon>\n          </md-icon-button>\n        </div>\n        <md-menu id=\"menu\">\n          <md-menu-item @click=\"${this.stopAgent}\">Stop Agent</md-menu-item>\n          <!-- Add more menu items as needed -->\n        </md-menu>\n      </div>\n    `;\n  }\n}\n"]}